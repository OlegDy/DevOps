## Домашнее задание 54 [11.3 Микросервисы: подходы](https://github.com/netology-code/micros-homeworks/blob/main/11-microservices-03-approaches.md)

### Олег Дьяченко DEVOPS-22

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.


### Ответ

На ум приходят несколько распространенных продуктов: Jenkins, TeamCity, GitLab Ci/CD.
И по сути они все подходят.

* TeamCity. Надежный и качественный CI/CD-инструмент. Есть бесплатная лицензия TeamCity Professional с ограничениями на запуск 3 агентов и 100 конфигураций сборок, чего хватает для начального процесса разработки. По отзывам TeamCity очень дружественен к пользователям. У него меньше функционала по сравнению с Gitlab, но и разобраться с ним в разы проще. 

* Jenkins система с открытым исходным кодом и множеством внешних расширений. Позволяет автоматизировать часть процесса разработки программного обеспечения, без участия человека. Данная система предназначена для обеспечения процесса непрерывной интеграции программного обеспечения. Используется практически в любой современной компании, где есть необходимость в автоматическом деплойменте (развертывании) приложений, а также в удобном управлении различного рода задач. Низкий порог входа.

* GitLab Ci/CD. Популярный веб-сервис для совместной разработки и поддержки программного обеспечения, система с открытым исходным кодом. Можно работать с Git-репозиториями, управлять задачами, обсуждать правки с вашей командой, писать wiki-документацию, оценивать качество, выпускать релизы и даже мониторить работающие программы — и всё это в одном месте.

Практики маловато, в объеме курсов. TeamCity все-таки имеет ограничение в которое со временем можно упереться, и потом не получится проплатить из-за санкционной политики, пропускаем. GitLab Ci/CD мега комбайн, но по отзывам, если что-то не стандартное то можно так упереться что и костыли не помогут. Я бы остановился на старом добром Jenkins как говорят и обвешать его плагинами и доп ПО.

Но выбирая CI/CD-систему стоит, помимо её возможностей, принимать во внимание и те затраты, которые могут быть с ней связаны, и то, с чем именно привыкли работать DevOps-инженеры, поддерживающие проект.


## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

### Ответ

Конечно любой скажет что есть Elasticsearch-Logstash-Kibana (ELK) и все, но я бы предложил Opensearch, ранее известный как Open Distro for Elasticsearch – аналог стека ELK, но с интегрированным модулем безопасности (в ELK это платная опция).

OpenSearch – система полнотекстового поиска. Является форком Elasticsearch. Разработана компанией A9.com, дочерней компанией Amazon.com.

Стэк OpenSearch (OpenSearch + Logstash-oss-with-OpenSearch-output-plugin + OpenSearch–Dashboards) является бесплатным аналогом с отрытым исходным кодом стэку ELK (Elasticsearch + Logstash + Kibana). В совокупности с Beat’ами (Filebeat, Winlogbeat, и т.д.) образуют полный цикл управления логами: сбор, систематизация, поиск.

И сделать схему как на рисунке.
![](https://habrastorage.org/webt/vm/am/8t/vmam8t-8lqksyqchxxtmz4wj8o8.png)


### Список ссылок:  
[Установка, настройка и эксплуатация стэка OpenSearch в классической среде](https://habr.com/ru/articles/662527/)

[Установка и запуск Opensearch / Dashboard / Logstash в режиме single-node в docker compose](https://itdraft.ru/2021/10/20/ustanovka-i-zapusk-opensearch-dashboard-logstash-v-rezhime-single-node-v-docker-compose/)


## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

### Ответ

Я предлагаю использовать мониторинг серверов на основе Prometheus+Grafana+Node_exporter.

Prometheus - центральный сервер, предназначенный для сбора и хранения данных. Данные постоянно изменяются во времени. Сервер Prometheus с заданной периодичностью считывает метрики и помещает полученные данные в Time Series DB. Кроме того, Prometheus предоставляет интерфейс для выполнения запросов и визуализации полученных данных.

Exporters — процессы, обеспечивающие сбор и их передачу серверу Prometheus. Существует много разных exporters, например: Node_exporter, Mysqld_exporter, Postgres_exporter.

Grafana — удобный frontend для визуализации накопленных данных, может использоваться для работы с данными сервера Prometheus, предоставляет различные преднастроенные Dashboard для отображения данных.

Помимо функций сбора, анализа и визуализации данных, Prometheus и Grafana поддерживают настраиваемые оповещения. В Grafana этот механизм является встроенным, в Prometheus он реализуется отдельным компонентом (Alert_manager). 

[Мониторинг серверов на основе Prometheus+Grafana+Node_exporter](https://mcs.mail.ru/docs/additionals/cases/cases-monitoring/case-node-exporter)